<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Map (Plotly)</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  html,body{margin:0;height:100%;overflow:hidden;font-family:sans-serif}
  #map{width:100%;height:100%}
  #dialog{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#fff;color:#000;padding:12px;border-radius:10px;display:none;z-index:999}
  .btn{display:inline-block;padding:8px 12px;margin:6px;border-radius:8px;background:#2b8cff;color:#fff;cursor:pointer}
  .cancel{background:#777}
  .note{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(43,140,255,0.95);color:#fff;padding:8px 12px;border-radius:8px;z-index:1000}

</style>
</head>
<body>
  <!-- <div id="mainApp" class="main">
    <h1>Привет из Mini App </h1>
    <p>MiniApp успешно открыт в Telegram!</p>
    <button id="actionBtn" class="btn">Открыть форму</button>

    <form id="dataForm">
      <input required="" id="nameInput" placeholder="Ваше имя" type="text">
      <textarea required="" id="msgInput" placeholder="Ваше сообщение"></textarea>
      <button class="btn" type="submit">Отправить</button>
    </form>
  </div> -->
<div id="map"></div>
<div id="dialog"><div id="dialog-text"></div><div class="btn" id="btn-yes">Да</div><div class="btn cancel" id="btn-no">Нет</div></div>

<script>
  const tg = window.Telegram?.WebApp || null;
  
  if (tg) tg.expand();// <--- иначе MiniApp закрывается!
  // === points вставляются generate_map.py ===
  const points = [{"name": "ОТ ДП №3", "lat": 55.61259, "lon": 37.676406, "description": "Детская площадка №3"}, {"name": "ОТ ДП №10 Ремонт", "lat": 55.616221, "lon": 37.692349, "description": "Детская площадка №10\nВ настоящий момент проводится устройство детской площадки с заменой игрового оборудования"}, {"name": "ОТ ДП №6", "lat": 55.607695, "lon": 37.682069, "description": "Детская площадка №6"}, {"name": "ЗО БП ДП №1", "lat": 55.632691, "lon": 37.705633, "description": "Детская площадка №1 Амурский тигр"}, {"name": "ЗО БП ДП №2", "lat": 55.633113, "lon": 37.706731, "description": "Детская площадка №2"}, {"name": "ЗО БП ДП №3", "lat": 55.633372, "lon": 37.707366, "description": "Детсая площадка №3 Китайский городок"}, {"name": "ЗО БП ДП №4", "lat": 55.632831, "lon": 37.707036, "description": "Детская площадка №4"}, {"name": "ЗО БП ДП №5", "lat": 55.63448, "lon": 37.711259, "description": "Детская площадка №5 Панда"}, {"name": "ЗО БП ДП №6", "lat": 55.632559, "lon": 37.72122, "description": "Детская площадка №6"}, {"name": "ЗО БП ДП № 1", "lat": 55.623057, "lon": 37.694692, "description": "Детская площадка № 1 Акула"}, {"name": "ЗО БП ДП №3", "lat": 55.625403, "lon": 37.70062, "description": "Детская площадка №3 Мамонт"}, {"name": "ЗО БП ДП №4", "lat": 55.626393, "lon": 37.697459, "description": "Детская площадка №4"}, {"name": "Парк БП ДП №5", "lat": 55.628242, "lon": 37.701822, "description": "Детская площадка №5 "}, {"name": "Парк БП ДП №6", "lat": 55.627233, "lon": 37.70442, "description": "Детская площадка №6 Космос"}, {"name": "Парк БП ДП №7", "lat": 55.627233, "lon": 37.70442, "description": "Детская площадка №7 Космос 2"}, {"name": "Парк БП ДП №8", "lat": 55.629521, "lon": 37.716036, "description": "Детская площадка №8"}, {"name": "Парк БП ДП №9", "lat": 55.627984, "lon": 37.718135, "description": "Детская площадка №9"}, {"name": "Парк БП ДП №10", "lat": 55.628456, "lon": 37.720749, "description": "Детская площадка №10"}, {"name": "Парк БП ДП №11", "lat": 55.628456, "lon": 37.720749, "description": "Детская площадка №11"}, {"name": "Парк БП ДП №12", "lat": 55.629103, "lon": 37.710093, "description": "Детская площадка №12"}, {"name": "Парк БП ДП №13", "lat": 55.629161, "lon": 37.709839, "description": "Детская площадка №13"}, {"name": "Парк БП ДП № 1", "lat": 55.63308, "lon": 37.699715, "description": "Детская площадка № 1 Замок"}, {"name": "БД ДП №1", "lat": 55.600053, "lon": 37.707492, "description": "Детская площадка №1"}, {"name": "БД ДП №9", "lat": 55.587879, "lon": 37.678532, "description": "Детская площадка №9"}, {"name": "БД ДП №3", "lat": 55.601433, "lon": 37.671658, "description": "Детская площадка №3"}, {"name": "БД ДП №4", "lat": 55.589287, "lon": 37.676938, "description": "Детская площадка №4"}, {"name": "БД ДП №5", "lat": 55.590044, "lon": 37.6784, "description": "Детская площадка №5"}, {"name": "БД ДП №6", "lat": 55.590708, "lon": 37.678656, "description": "Детская площадка №6"}, {"name": "БД ДП №7", "lat": 55.590035, "lon": 37.679111, "description": "Детская площадка №7"}, {"name": "БД ДП №8", "lat": 55.587913, "lon": 37.679186, "description": "Детская площадка №8"}];
  
  if (!points || !Array.isArray(points) || points.length === 0) {
    document.body.innerHTML = "<div style='padding:20px;color:#fff;'>Нет точек для отображения.</div>";
    throw new Error("No points");
  }
  
  tg.ready(); // сообщаем Telegram, что MiniApp готов к работе 

  // строим Plotly карту
  const lat = points.map(p => p.lat), lon = points.map(p => p.lon), text = points.map(p=>p.name);
  const data = [{ type: "scattermapbox", lat, lon, text, mode: "markers", marker:{size:14} }];
  const layout = { mapbox:{ style:"open-street-map", center:{lat:lat[0],lon:lon[0]}, zoom:12 }, margin:{t:0,b:0,l:0,r:0} };
    
  Plotly.newPlot("map", data, layout).then(gd => {
    let selectedPoint = null;
    const dialog = document.getElementById("dialog");
    const dialogText = document.getElementById("dialog-text");

    gd.on('plotly_click', e => {
      const idx = e.points[0].pointIndex;
      selectedPoint = points[idx];

      Plotly.relayout(gd, {"mapbox.center": {lat: selectedPoint.lat, lon: selectedPoint.lon}, "mapbox.zoom": 15});
      dialogText.textContent = `Точка: ${selectedPoint.name}. Сделать фотографии?`;
      dialog.style.display = 'block';
    });

    document.getElementById("btn-no").onclick = () => { dialog.style.display = 'none'; };

    document.getElementById("btn-yes").onclick = () => {
      if (!selectedPoint) return;

      // уведомление в WebApp
      const note = document.createElement('div');
      note.className = 'note';
      note.innerText = `Режим фото для точки "${selectedPoint.name}" включён`;
      document.body.appendChild(note);

     // отправляем данные МГНОВЕННО
    if (tg) {
      tg.sendData(JSON.stringify({ action: "start_photos", point: selectedPoint.name }));
      tg.close();
    } else {
        alert("tg недоступен — откройте WebApp в Telegram");
      }
    };
  });
</script>
</body>
</html>
